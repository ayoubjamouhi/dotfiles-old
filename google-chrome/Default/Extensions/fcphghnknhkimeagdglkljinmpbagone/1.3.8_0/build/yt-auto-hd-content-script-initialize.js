!function(){"use strict";const t=[4320,2160,1440,1080,720,480,360,240,144].find((t=>t<=screen.height)),e={qualities:{60:t,50:t,30:t},autoResize:!0,size:1};async function n(t={}){const{size:n=e.size,autoResize:o=e.autoResize}=Object.assign(t,await i("sync"));if(!o)return;const c=document.body.querySelector(".ytp-size-button"),s=c.querySelector("path")?.getAttribute("d");if(!s)return;const u="m 26,13 0,10 -16,0 0,-10 z m -14,2 12,0 0,6 -12,0 0,-6 z"===s;n?"m 28,11 0,14 -20,0 0,-14 z m -18,2 16,0 0,10 -16,0 0,-10 z"===s&&c.click():u&&c.click()}async function i(t,e=null){return new Promise((n=>{chrome.storage[t].get(e,(t=>{n(e?t[e]:t)}))}))}function o(t,e){return Object.keys(t).length<Object.keys(e).length}async function c(){s("buttonSettings")?.ariaExpanded||a();const t=s("video");if(!function(){const t=s("optionQuality");if(!t)return!1;const e=".ytp-menuitem-content",n=t.querySelector(e)?.textContent?.match(/\d+/);if(!n)return!1;const i=n[0],o=3;return i.length>=o}()||!isNaN(parseInt(window.ythdLastQualityClicked))&&!window.ythdLastQualityClicked)return a(),void t.addEventListener("canplay",c,{once:!0});s("optionQuality").click(),await async function(t){const n=function(){const t=r()[0]?.textContent;if(!t)return 30;const e=t.match(/[ps](\d+)/);return e?Number(e[1]):30}(),c=r().map(l),s=r();let u=await async function(){let t=await i("local","qualities")??{};o(t,e.qualities)&&(t={...t,...e.qualities});return t}();o(u,e.qualities)&&(u=e.qualities);const d=function(t,e){const n=Object.keys(t).map(Number).sort(((t,e)=>e-t));for(;n.length>1;){const t=n.pop();if(e<=t)return t}return n[0]}(u,n),y=function(t,e){return t.findIndex((t=>t===e))}(c,t||u[d]);if(y>-1)s[y].click();else if(f=s[0],m=u[d],parseInt(f.textContent)<m)s[0].click();else{const t=c.findIndex((t=>t<=u[d]));t>-1?s[t].click():a()}var f,m}(window.ythdLastQualityClicked);const n=s("buttonSettings");document.activeElement===n&&n.blur(),t.focus()}function s(t,{isGetAll:e=!1}={}){const n={buttonSettings:".ytp-settings-button",optionQuality:".ytp-menuitem:last-child",menuOption:".ytp-menuitem",player:".html5-video-player",video:"video"};if(e)return[...document.querySelectorAll(n[t])];return[...document.querySelectorAll(n[t])].find(u)}function u(t){return t?.offsetWidth>0&&t?.offsetHeight>0}function a(){s("buttonSettings")?.click()}function r(){return s("menuOption",{isGetAll:!0}).filter(d)}function l(t){return parseInt(t.textContent)}function d(t){const e=Boolean(t.textContent.match(/\d/)),n=t.children.length>1;return e&&!n}chrome.storage.onChanged.addListener((async({qualities:t,autoResize:o,size:s})=>{if(t)return window.ythdLastQualityClicked=null,void c();if(o)n();else if(void 0!==s){(await i("sync","autoResize")??e.autoResize)&&n({size:s.newValue})}}));const y={childList:!0,subtree:!0};function f(){n(),c()}async function m({target:t}){const e=t.matches("span")?t:t.matches("div")?t.querySelector("span"):null,n=parseInt(e?.textContent);isNaN(n)||(window.ythdLastQualityClicked=n)}function p(){const t=s("player")||document.body,e=/(ytp-tooltip-title|ytp-time-current)/;new MutationObserver((async(t,n)=>{if((t=>Boolean(t[t.length-1].target.className.match(e)))(t))return;const i=s("video");i&&(window.ythdLastQualityClicked=null,f(),i.addEventListener("canplay",f),n.disconnect())})).observe(t,y)}window.ythdLastQualityClicked=null,new MutationObserver(((t,e)=>{const n=s("video");if(!n)return;const i=location.pathname.startsWith("/embed/");s("player").addEventListener("click",m),i?n.addEventListener("canplay",f):(f(),new MutationObserver(p).observe(document.querySelector("title"),y),e.disconnect())})).observe(document.body,y)}();
